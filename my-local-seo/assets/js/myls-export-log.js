/**
 * MYLS Export Log – exports terminal-style results log to PDF
 * Uses jsPDF loaded from CDN (lazy-loaded on first export).
 *
 * Usage:
 *   <button class="myls-btn-export-pdf" data-log-target="myls_ai_about_results">
 *     <i class="bi bi-file-earmark-pdf"></i> PDF
 *   </button>
 *
 * The data-log-target attribute must match the ID of the results <pre>/<div>.
 */
(function(){
  'use strict';

  var jsPDFReady = false;
  var jsPDFLoading = false;
  var pendingCallbacks = [];

  function ensureJsPDF(cb) {
    if (jsPDFReady && window.jspdf) { cb(); return; }
    pendingCallbacks.push(cb);
    if (jsPDFLoading) return;
    jsPDFLoading = true;
    var s = document.createElement('script');
    s.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js';
    s.onload = function(){
      jsPDFReady = true;
      pendingCallbacks.forEach(function(fn){ fn(); });
      pendingCallbacks = [];
    };
    s.onerror = function(){
      alert('Failed to load jsPDF library. Check your internet connection.');
      jsPDFLoading = false;
      pendingCallbacks = [];
    };
    document.head.appendChild(s);
  }

  function getTimestamp() {
    var d = new Date();
    var pad = function(n){ return n < 10 ? '0'+n : ''+n; };
    return d.getFullYear()+'-'+pad(d.getMonth()+1)+'-'+pad(d.getDate())+'_'+
           pad(d.getHours())+pad(d.getMinutes());
  }

  function getTabLabel() {
    // Try to detect which AI subtab is active
    var active = document.querySelector('.myls-subtab-btn.active, .nav-link.active');
    if (active) return active.textContent.trim().replace(/[^a-zA-Z0-9 ]/g, '').trim();
    return 'Results';
  }

  function exportLog(targetId) {
    var el = document.getElementById(targetId);
    if (!el) { alert('Results log not found.'); return; }

    var text = (el.innerText || el.textContent || '').trim();
    if (!text || text === 'Ready.' || text === 'Ready') {
      alert('No results to export yet. Run a generation first.');
      return;
    }

    ensureJsPDF(function(){
      var jsPDF = window.jspdf.jsPDF;
      var doc = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a4' });

      var pageW = doc.internal.pageSize.getWidth();
      var pageH = doc.internal.pageSize.getHeight();
      var marginL = 14;
      var marginR = 14;
      var marginTop = 20;
      var marginBot = 16;
      var usableW = pageW - marginL - marginR;

      // ── Header ──
      var tabLabel = getTabLabel();
      var timestamp = new Date().toLocaleString();

      doc.setFillColor(11, 18, 32); // #0b1220
      doc.rect(0, 0, pageW, 14, 'F');
      doc.setFont('courier', 'bold');
      doc.setFontSize(10);
      doc.setTextColor(209, 231, 255); // #d1e7ff
      doc.text('My Local SEO – ' + tabLabel + ' Log', marginL, 9);
      doc.setFont('courier', 'normal');
      doc.setFontSize(7);
      doc.setTextColor(139, 148, 158);
      doc.text(timestamp, pageW - marginR, 9, { align: 'right' });

      // ── Body ──
      doc.setFont('courier', 'normal');
      doc.setFontSize(8);
      doc.setTextColor(209, 231, 255); // #d1e7ff

      var lines = doc.splitTextToSize(text, usableW);
      var y = marginTop;
      var lineH = 3.6;

      // Dark background per page
      function drawPageBg() {
        doc.setFillColor(11, 18, 32);
        doc.rect(0, 14, pageW, pageH - 14, 'F');
      }
      drawPageBg();

      for (var i = 0; i < lines.length; i++) {
        if (y + lineH > pageH - marginBot) {
          // Footer
          doc.setFontSize(6);
          doc.setTextColor(72, 79, 88);
          doc.text('Page ' + doc.getNumberOfPages(), pageW - marginR, pageH - 6, { align: 'right' });

          doc.addPage();
          drawPageBg();
          y = marginTop;
          doc.setFontSize(8);
          doc.setTextColor(201, 209, 217);
        }

        var line = lines[i];
        // Color-code lines
        if (/saved|success|ok|done|✅/i.test(line)) {
          doc.setTextColor(57, 255, 20); // green
        } else if (/error|fail|❌/i.test(line)) {
          doc.setTextColor(255, 85, 85); // red
        } else if (/skip|already|⏭/i.test(line)) {
          doc.setTextColor(255, 215, 0); // gold
        } else if (/^[\-=]+$/.test(line.trim()) || /^#{1,3}\s/.test(line)) {
          doc.setTextColor(88, 166, 255); // blue headings/separators
        } else {
          doc.setTextColor(209, 231, 255); // #d1e7ff default
        }

        doc.text(line, marginL, y);
        y += lineH;
      }

      // Final page footer
      doc.setFontSize(6);
      doc.setTextColor(72, 79, 88);
      doc.text('Page ' + doc.getNumberOfPages(), pageW - marginR, pageH - 6, { align: 'right' });
      doc.text('Generated by My Local SEO Plugin', marginL, pageH - 6);

      var filename = 'MYLS-' + tabLabel.replace(/\s+/g, '-') + '-' + getTimestamp() + '.pdf';
      doc.save(filename);
    });
  }

  // ── Event delegation ──
  document.addEventListener('click', function(e) {
    var btn = e.target.closest('.myls-btn-export-pdf');
    if (!btn) return;
    e.preventDefault();
    var target = btn.getAttribute('data-log-target');
    if (target) exportLog(target);
  });

})();
